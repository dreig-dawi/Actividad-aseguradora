<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad aseguradora</title>
    <style>
        form {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 10px;
        }

        div {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .wrong {
            display: none;
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <form>
        <div id="nombre_div">
            <label for="nombre">Nombre</label>

            <!-- Limita el campo a 30 caracteres -->
            <input id="nombre" type="text"  placeholder="Nombre" maxlength="30">
        </div>
            
        <div id="apellidos_div">
            <label for="apellidos">Apellidos</label>
            <input id="apellidos" type="text" placeholder="Apellidos">
        </div>

        <div id="DNI_div">
            <label for="DNI">DNI</label>
            <input id="DNI" type="text" placeholder="01234567X">
        </div>

        <div id="correo_div">
            <label for="correo">Correo electrónico</label>
            <input id="correo" type="text" placeholder="abc@def.com">
        </div>

        <div id="telefono_div">
            <label for="telefono">Teléfono</label>
            <input id="telefono" type="number" placeholder="123456789">
        </div>

        <div id="codigo_postal_div">
            <label for="codigo_postal">Código postal</label>
            <input id="codigo_postal" type="number" placeholder="12345">
        </div>

        <div id="carnet_div">
            <label for="carnet">Fecha de expedición del carnet de conducir</label>
            <input id="carnet" type="date">
        </div>

        <div id="matriculacion_div">
            <label for="matriculacion">Fecha de matriculación</label>
            <input id="matriculacion" type="date">
        </div>

        <div id="nacimiento_div">
            <label for="nacimiento">Fecha de nacimiento</label>
            <input id="nacimiento" type="date">
        </div>

        <div id="sexo_div">
            <label for="sexo">Sexo</label>
            <select id="sexo">
                <option value="hombre">Hombre</option>
                <option value="mujer">Mujer</option>
                <option value="otro">Otro</option>
            </select>
        </div>

        <div id="comunidad_provincia_div">
            <label for="comunidad">Comunidad autónoma</label>
            <select id="comunidad">
                <option value="andalucia">Andalucía</option>
                <option value="aragon">Aragón</option>
                <option value="asturias">Asturias</option>
                <option value="baleares">Baleares</option>
                <option value="canarias">Canarias</option>
                <option value="cantabria">Cantabria</option>
                <option value="castilla_la_mancha">Castilla-La Mancha</option>
                <option value="castilla_y_leon">Castilla y León</option>
                <option value="cataluña">Cataluña</option>
                <option value="comunidad_valenciana">Comunidad Valenciana</option>
                <option value="extremadura">Extremadura</option>
                <option value="galicia">Galicia</option>
                <option value="madrid">Madrid</option>
                <option value="murcia">Murcia</option>
                <option value="navarra">Navarra</option>
                <option value="pais_vasco">País Vasco</option>
                <option value="la_rioja">La Rioja</option>
                <option value="ceuta">Ceuta</option>
                <option value="melilla">Melilla</option>
            </select>
            
            <label for="provincia">Provincia</label>
            <select id="provincia"></select>
        </div>

        <div id="marca_modelo_div">
            <label for="marca">Marca</label>
            <select id="marca">
                <option value="alfa_romeo">Alfa Romeo</option>
                <option value="audi">Audi</option>
                <option value="bmw">BMW</option>
                <option value="citroen">Citroën</option>
                <option value="fiat">Fiat</option>
                <option value="ford">Ford</option>
                <option value="honda">Honda</option>
                <option value="hyundai">Hyundai</option>
                <option value="kia">Kia</option>
                <option value="mazda">Mazda</option>
                <option value="mercedes">Mercedes</option>
                <option value="mini">Mini</option>
                <option value="nissan">Nissan</option>
                <option value="opel">Opel</option>
                <option value="peugeot">Peugeot</option>
                <option value="renault">Renault</option>
                <option value="seat">Seat</option>
                <option value="skoda">Skoda</option>
                <option value="toyota">Toyota</option>
                <option value="volkswagen">Volkswagen</option>
                <option value="volvo">Volvo</option>
            </select>
            <label for="modelo">Modelo</label>
            <select id="modelo"></select>
            <label for="seguro">Tipo de seguro</label>
            <select id="seguro">
                <option value="terceros">Terceros</option>
                <option value="terceros_ampliado">Terceros ampliado</option>
                <option value="franquicia">Con franquicia</option>
                <option value="todo_riesgo">Todo riesgo</option>
            </select>
        </div>
        
        <div id="vehiculo_div">
            <label for="vehiculo">Tipo de vehículo</label>
            <select id="vehiculo">
                <option value="diesel">Diesel</option>
                <option value="gasolina">Gasolina</option>
                <option value="hibrido">Híbrido</option>
                <option value="electrico">Eléctrico</option>
            </select>
        </div>

        <div id="archivo_div">
            <label for="archivo">Subir archivo (jpg/jpeg/png)</label>

            <!-- Limita el tipo de archivo a jpg -->
            <input id="archivo" type="file" accept=".jpg">
        </div>

        <div id="terminos_div">
            <label for="terminos">Acepto los términos y condiciones</label>
            <input id="terminos" type="checkbox">
        </div>

        <button type="button" onclick="find();">Encontrar seguro</button>
    </form>

    <script>
        // Validators
        function validateNombre() {
            const nombre = document.getElementById("nombre");
            if (nombre.value.length < 30) {
                checkValid(onlyWords(nombre.value), nombre);
            } else {
                invalidInput(nombre);
            }
        }

        function validateApellidos() {
            const apellidos = document.getElementById("apellidos");

            checkValid(onlyWords(apellidos.value), apellidos);
        }

        function validateDNI() {
            const DNI = document.getElementById("DNI");

            // Regex permite 8 números seguidos de una letra
            const DNIRegex = /^[0-9]{8}[a-zA-Z]$/;

            checkValid(DNIRegex.test(DNI.value), DNI);
        }
           
        function validateNacimiento() {
            const nacimiento = document.getElementById("nacimiento");

            checkValid(isAdult(nacimiento.value), nacimiento);
        }

        function validateCarnet() {
            const carnet = document.getElementById("carnet");

            checkValid(isPast(carnet.value), carnet);
        }

        function validateMatriculacion() {
            const matriculacion = document.getElementById("matriculacion");

            checkValid(isPast(matriculacion.value), matriculacion);
        }

        function validateMatricula() {
            const matricula = document.getElementById("matricula");

            // Regex permite 4 números seguidos de 3 letras
            const matriculaRegex = /^[0-9]{4}[a-zA-Z]{3}$/;

            checkValid(matriculaRegex.test(matricula.value), matricula);
        }

        function validateCodigoPostal() {
            const codigoPostal = document.getElementById("codigo_postal");

            // Regex permite 5 números
            const codigoPostalRegex = /^[0-9]{5}$/;

            checkValid(codigoPostalRegex.test(codigoPostal.value), codigoPostal);
        }

        function validateArchivo() {
            const archivo = document.getElementById("archivo");

            // Comprueba que el archivo sea de tipo jpg
            checkValid(archivo.value.endsWith(".jpg"), archivo);
        }

        // Main
        window.onload = function() {
            setProvinciasList();
            setEvents();
        };

        // Event setters
        function setEvents() {
            setValidators();
            setProvinciasList();
            document.getElementById("comunidad").addEventListener("change", setProvinciasList);
        }

        function setValidators() {
            document.getElementById("nombre").addEventListener("blur", validateNombre);
            document.getElementById("apellidos").addEventListener("blur", validateApellidos);
            document.getElementById("DNI").addEventListener("blur", validateDNI);
            document.getElementById("nacimiento").addEventListener("input", validateNacimiento);
            document.getElementById("carnet").addEventListener("input", validateCarnet);
            document.getElementById("matriculacion").addEventListener("input", validateMatriculacion);
            document.getElementById("codigo_postal").addEventListener("blur", validateCodigoPostal);
            document.getElementById("archivo").addEventListener("change", validateArchivo);
        }

        function setProvinciasList() {
            switch (document.getElementById("comunidad").value) {
                case "andalucia":
                    setProvincias(["Almería", "Cádiz", "Córdoba", "Granada", "Huelva", "Jaén", "Málaga", "Sevilla"]);
                    break;
                case "aragon":
                    setProvincias(["Huesca", "Teruel", "Zaragoza"]);
                    break;
                case "asturias":
                    setProvincias(["Asturias"]);
                    break;
                case "baleares":
                    setProvincias(["Baleares"]);
                    break;
                case "canarias":
                    setProvincias(["Las Palmas", "Santa Cruz de Tenerife"]);
                    break;
                case "cantabria":
                    setProvincias(["Cantabria"]);
                    break;
                case "castilla_la_mancha":
                    setProvincias(["Albacete", "Ciudad Real", "Cuenca", "Guadalajara", "Toledo"]);
                    break;
                case "castilla_y_leon":
                    setProvincias(["Ávila", "Burgos", "León", "Palencia", "Salamanca", "Segovia", "Soria", "Valladolid", "Zamora"]);
                    break;
                case "cataluña":
                    setProvincias(["Barcelona", "Girona", "Lleida", "Tarragona"]);
                    break;
                case "comunidad_valenciana":
                    setProvincias(["Alicante", "Castellón", "Valencia"]);
                    break;
                case "extremadura":
                    setProvincias(["Badajoz", "Cáceres"]);
                    break;
                case "galicia":
                    setProvincias(["A Coruña", "Lugo", "Ourense", "Pontevedra"]);
                    break;
                case "madrid":
                    setProvincias(["Madrid"]);
                    break;
                case "murcia":
                    setProvincias(["Murcia"]);
                    break;
                case "navarra":
                    setProvincias(["Navarra"]);
                    break;
                case "pais_vasco":
                    setProvincias(["Álava", "Gipuzkoa", "Bizkaia"]);
                    break;
                case "la_rioja":
                    setProvincias(["La Rioja"]);
                    break;
            }
        }

        function setProvincias(provinciasList) {
            const provincias = document.getElementById("provincia");

            // Elimina las provincias anteriores
            while (provincias.firstChild) {
                provincias.removeChild(provincias.firstChild);
            }

            // Añade las nuevas provincias
            provinciasList.forEach(provincia => {
                const option = document.createElement("option");
                option.value = provincia;
                option.textContent = provincia;
                provincias.appendChild(option);
            });
        }

        // Utils
        function onlyWords(value) {

            // Regex para que solo se permitan letras, acentos y espacios
            const onlyWordsRegex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑàèìòùÀÈÌÒÙäëïöüÄËÏÖÜâêîôûÂÊÎÔÛ\s]+$/;

            return onlyWordsRegex.test(value);
        }

        function isAdult(value) {
            const date = new Date(value);
            const now = new Date();

            // Convierte el resultado a años
            const age = (now - date) / (1000 * 60 * 60 * 24 * 365.25);

            // Si la edad es mayor o igual a 18, es adulto
            return age >= 18;
        }

        function isPast(value) {
            const date = new Date(value);
            const now = new Date();

            // Si la fecha es anterior a la actual, es válida
            return date < now;
        }

        function checkValid(condition, input) {
            if (condition) {
                validInput(input);
            } else {
                invalidInput(input);
            }
        }

        function invalidInput(input) {
            const wrong = document.createElement("p");
            wrong.id = "wrong_" + input.id;
            wrong.textContent = '❌';

            // TODO: Que no se creen cruces extra
            // TODO: Añadir mensaje de error al icono
            input.parentNode.appendChild(wrong);
        }
        
        function validInput(input) {
            const wrong = document.getElementById("wrong_" + input.id);
            wrong.style.display = 'none';
        }

        function calculateBasePrice() {
            switch (document.getElementById("seguro").value) {
                case "terceros":
                    return 500;
                case "terceros_ampliado":
                    return 650;
                case "franquicia":
                    return 750;
                case "todo_riesgo":
                    return 1000;
            };
        }

        function isOldAdult() {
            const nacimiento = document.getElementById("nacimiento");

            const date = new Date(nacimiento.value);
            const now = new Date();

            // Convierte el resultado a años
            const age = (now - date) / (1000 * 60 * 60 * 24 * 365.25);

            // Si la edad es mayor o igual a 25, es adulto
            return age >= 25;
        }

        function isNewDriver() {
            const carnet = document.getElementById("carnet");

            const date = new Date(carnet.value);
            const now = new Date();

            // Convierte el resultado a años
            const age = (now - date) / (1000 * 60 * 60 * 24 * 365.25);

            // Si la edad es menor o igual a 2, es nuevo conductor
            return age <= 5;
        }

        function vehiculoTypePriceModifier(price) {
            switch (document.getElementById("vehiculo").value) {
                case "diesel":
                    return price * 1.2;
                case "gasolina":
                    return price * 1.15;
                case "hibrido":
                    return price * 1.05;
                case "electrico":
                    return price;
            }
        }

        function priceCalculator() { 
            const price = calculateBasePrice();       
            
            price = isOldAdult() ? price : price * 1.1;

            price = isNewDriver() ? price * 1.1 : price;

            price = vehiculoTypePriceModifier(price);
        }
    </script>
</body>
</html>